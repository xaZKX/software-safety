# 软件安全测试及Fuzzing

## 0x01 软件测试技术

软件测试可识别应用程序代码中必须修复的缺陷，瑕疵或错误。软件测试还可以定义为通过分析访问软件功能和正确性的过程。测试的主要目的可以是质量保证，可靠性评估，确认和验证。软件测试是软件质量保证的基本组成部分，代表对软件规范、设计和编码的审查。软件测试的主要目的是通过在精心控制的环境下对软件进行系统的测试来确认软件系统的质量，另一个目的是识别软件的完整性和正确性，最后发现未发现的错误。有三个用于发现错误的技术分别是：白盒测试、黑盒测试以及灰盒测试。

### 1.1 白盒测试技术

- 白盒测试是一种利用程序设计的控制结构来派生测试用例的测试用例的设计方法。白盒测试可以通过分析软件的内部工作和结构来发现实施错误，比如糟糕的密钥管理。白盒测试是对代码内部逻辑和结构的详细研究。在白盒测试中，测试人员需要查看源代码，找出哪些代码单元行为不当。

- 白盒测试的优点：
  1. 它通过删除额外的代码行来揭示隐藏代码中的错误。
  2. 副作用是有益的。
  3. 在编写测试场景时可以获得最大的覆盖率。

- 白盒测试的缺点：
  1. 代价高昂，因为需要一个熟练的测试人员来执行。
  2. 许多路径仍然没有经过测试，因为查看每个角落来找出隐藏的错误是非常困难的。
  3. 代码中遗漏的一些代码可能无法查出。

- 下面简要描述一些重要类型的白盒测试技术：
  1. 控制流测试：这是一种结构测试策略，它使用程序控制流作为模型控制流，比起较少但复杂的路径，它更倾向于使用较多但简单的路径。
  2. 分支测试：分支测试的目的是检验每一个控制语句上的每一个选项（真或假），也包括复合决策。
  3. 基础路径测试：基础路径测试允许测试用例设计人员生成程序设计的逻辑复杂度度量，然后使用该度量作为概括一组基本执行路径集的方法。
  4. 数据流测试：在这种类型的测试中，控制流图被标注如何定义和使用程序变量的信息。
  5. 循环测试：它关注循环结构的有效性。

### 1.2 黑盒测试技术

- 黑盒测试将软件视为“黑匣子”，是一种无需了解应用程序内部工作的情况下进行测试的技术。它只检查系统的基本方面，与系统的内部逻辑结构没有或几乎没有关系。在执行黑盒测试时，测试人员必须知道系统架构，并且不能访问源代码。
- 黑盒测试的优点：
  1. 高效的大型代码段。
  2. 测试人员的感知非常简单。
  3. 用户视角与开发人员视角是明显分离的（程序员盒测试人员彼此独立）。
  4. 更快的测试用例开发。

- 黑盒测试的缺点：
  1. 实际上只执行选定的一些测试场景，因此覆盖范围有限。
  2. 没有明确的规范测试用例很难设计。
  3. 测试效率低。
- 下面简要描述一些重要类型的黑盒测试技术：
  1. 等价划分：它可以减少测试用例的数量，因为它将软件单元的输入数据划分成可以派生测试用例的数据分区。
  2. 边界值分析：它更侧重于边界测试，或者选择极端边界值。它包括最小值，最大值，内部/外部边界，误差值和典型值。
  3. 模糊测试：模糊测试用于查找实现错误，在自动或半自动会话中使用畸形/半畸形数据注入。
  4. 因果图：这是一种测试技术，测试从创建一个图开始，建立效果与原因之间的关系。同一性，否定性，逻辑或和逻辑与是表达因果因果关系的四个基本符号。
  5. 正交阵列测试：OAT适用于输入域较小，但是过大而无法容纳穷举测试的问题。
  6. 全对测试：在全对测试技术中，测试用例是设计用来执行每对输入参数的所有可能的离散组合。它的主要目标是拥有一组覆盖所有对的测试用例。
  7. 状态转换测试：这类测试对于测试状态机和图形用户界面的导航都很有用。

### 1.3 灰盒测试技术

- 白盒+黑盒=灰盒，它是一种测试应用程序的技术，它对应用程序的内部工作有一定的了解，并且对系统的基本方面也有一定的了解。在灰盒测试中，为了设计测试用例，测试人员必须了解内部数据结构和算法。灰盒测试技术的例子如下：
  1. 建筑模型
  2. 统一建模语言（UML）
  3. 状态模型（有限状态机）
- 灰盒测试的优点：
  1. 灰盒测试提供了白盒和黑盒测试技术的综合优势。
  2. 在灰盒测试中，测试人员依赖于接口定义和功能规范，而不是源代码。
  3. 在灰盒测试中，测试人员可以设计出优秀的测试场景。
  4. 测试是从用户的角度而不是设计者的角度进行的。
  5. 创建智能测试创作。
  6. 无偏见的测试。
- 灰盒测试的缺点：
  1. 由于无法访问源代码，测试覆盖范围受到限制。
  2. 在分布式应用程序中，很难将缺陷识别关联起来。
  3. 许多程序路径仍然没有经过测试。
  4. 如果软件设计人员已经运行了一个测试用例，那么测试可能是多余的。
- 下面简要描述一些重要类型的灰盒测试技术：
  1. 正交数组测试:这种测试使用所有可能组合的子集。
  2. 矩阵测试:在矩阵测试中说明项目的状态报告。
  3. 回归测试:如果软件中有新的变化，回归测试就意味着测试用例的运行。
  4. 模式测试:模式测试验证了其架构和设计的良好应用。

## 0x02 模糊（Fuzzing）测试

### 2.1 简介

- 大多数计算机系统入侵都是由于应用程序中存在安全漏洞。检测和识别安全漏洞不仅对安全专家和系统管理员来说是一个有趣的过程，对于试图渗透计算机系统的入侵者来说也是如此。一旦检测到新的安全漏洞，就可以创建新的攻击，入侵者可以渗透Internet上的大量系统。这是对所有信息系统用户的重大威胁。
- 以下几种方法可以查找新的安全漏洞：
  - 源代码分析
  - 二进制文件分析（静态分析和动态（运行时）分析）
  - API函数运行时分析
  - 模糊（Fuzzing）测试方法
  - 混合方法（上述方法的各种组合）
- 尽管上面列出的所有方法都可以检测到新的安全漏洞，但其中的一些方法由于速度更快和检测更简单而更好。其中，Fuzzing技术特别受到人们的关注。这种方法允许相对快速地检测各种应用程序中的关键安全漏洞。关键安全漏洞通常是缓冲区溢出攻击的变体，这种攻击允许未经授权的用户覆盖脆弱进程内存的关键部分。利用此漏洞的结果通常是一段shellcode的执行，这是未经授权的用户为了访问目标系统而注入到进程中的一种特殊编写的代码。
- 模糊化方法是基于故障注入技术，通过向目标应用程序发送各种输入数据以试图检测安全漏洞。使用此技术时，重要的是更改输入数据，以便能够检测到安全漏洞，同时通过目标应用程序的完整性检查。模糊化方法通常用于客户端和服务器应用程序、文件解析器、SUID应用程序等。通常，任何解析用户输入数据的应用程序都可以提交给模糊化方法，以检测安全漏洞。

- Fuzzing技术允许检测几乎所有类型的安全漏洞：
  - 缓冲区溢出
  - 正数溢出
  - 格式化字符串漏洞
  - 竞态条件漏洞
  - SQL注入
  - 跨站脚本（XSS）
  - 远程命令执行
  - 文件系统攻击（反向遍历等）
  - 信息泄漏漏洞
- 通过使用Fuzzing方法可以检测到目前发布在各种安全邮件列表上的大量安全漏洞。有大量的各种各样模糊工具允许用户检查应用程序的安全性，这增加了模糊化方法的流行程度。Fuzzing技术并不是一种通用的安全漏洞检测方法。为了检测某个安全漏洞，目标应用程序有一组可能不使用Fuzzing工具的特定条件。在这种情况下，必须应用其他一些方法，这取决于所分析的安全漏洞的类型。在讨论网络应用程序时，需要注意的是，Fuzzing技术对于应用程序稳定性的一般测试非常有用，因为这样的测试可能具有破坏性。

### 2.2 Fuzzing技术

#### 2.2.1 会话数据模糊（Session Data Fuzzing）

该方法是在分析合法会话的基础上应用的。会话的某些数据部分被增加并发送到测试的应用程序。这种技术基于这样一个事实，即fuzzer工具更改了已经存在的数据，因此应用程序可能会进入一个未确定的状态，从而导致安全漏洞。这种模糊测试方法的实现相对简单，并且可以检测到非常有趣的安全漏洞。

#### 2.2.2 专业的模糊器（Specialized Fuzzers）

第二个非常流行的fuzzing方法是构建专门的fuzzer应用程序，该应用程序经过调整以测试某个协议的实现。这种类型的模糊应用程序的优点是具有良好的知识和对所分析协议的适应性。这允许在目标应用程序上执行详细而有效的测试。在测试打开会话以在客户端和服务器之间交换控制数据的协议或网络应用程序（即SMTP，FTP，IMAP，SSH等）时，专用的模糊工具尤其有用。在这种情况下，模糊器通常仅针对特定协议和要测试的协议的元素构建。这种类型的模糊器应用的一个缺点是程序员自己定义的协议和其元素将被模糊化，因此模糊器的最终质量和有效性将取决于程序员的能力。

#### 2.2.3 通用的模糊器（Generic Fuzzers）

通用模糊器这个术语描述了允许用户描述协议以及需要模糊化的元素的工具。这样的工具的一大优点是，它们可以相对快速地测试各种协议实现的安全性。然而，通用模糊器不如专业模糊器有效，它们可以忽略某些安全漏洞。模糊器即将执行的所有测试都必须由用户定义，当用户希望测试复杂协议时，这可能是一个限制。SPIKE是一种非常流行的通用模糊器。通用模糊器的缺点之一是经验不足的用户通常很难使用它们。

### 2.3 服务器应用程序模糊测试

- 入侵者发现网络应用程序是最有趣的模糊测试目标。这是因为它们在Internet上使用而且通常可以被大量用户访问。这些服务器应用程序通常是流行协议(如HTTP、FTP、SMTP、POP3和SSH)的网络服务。还有其他不太受欢迎的网络服务，对模糊测试来说可能很有趣。因此，新的安全漏洞允许入侵者危害大量易受攻击的服务器。随着协议的复杂性(或数量或特性)的增加，协议实现(或服务器应用程序)中可能存在的安全漏洞的数量呈指数级增长。模糊器应用程序的特性和设计是影响其效率的非常重要的因素。其目标是构建一个在合理的时间内尽可能好地详细地测试应用程序安全性的模糊器。在讨论服务应用程序的模糊化时，重要的是要涵盖正在测试的协议的所有组件，因为缺少协议中看似不重要的部分的实现可能会导致缺少关键的安全漏洞。
- 为了缩短生成所有可能导致安全漏洞检测的输入数据组合所需的时间，模糊工具通常具有预定义的输入数据列表及其长度。测试输入数据由字符串组成，这些字符串将被相乘，直到它们达到定义的长度，然后将输入数据发送到目标应用程序。输入数据的长度对整个模糊化过程非常重要。太短的字符串将错过正在测试的安全漏洞，而太长的字符串可能会被应用程序丢弃，因此不会再次检测到安全漏洞。因此，最好使用应用程序中通常的缓冲区大小来定义字符串长度。
- 应用程序中最常用的缓冲区大小通常是2的幂。建议在定义测试输入数据时，使用比缓冲区大一点的长度(即，20、40、70、130、260等)。输入数据与正在测试的协议相关联也很重要；这对于特定于该协议及其实现的特殊字符和值非常重要。例如，如果SMTP服务器正在被模糊化，那么发送到目标应用程序的数据必须与电子邮件地址的构造相关。数据必须由“@”、“;”、“”等字符组成。'， '<'， '>'等等。如果HTTP服务器正在被模糊化，那么数据必须由“%xx”、“..”等字符组成。/ ',' ?'， '='，以此类推。
- 测试输入数据越适应正在测试的协议，就越有可能检测到安全漏洞。模糊器还必须使用尽可能多的输入数据测试应用程序。包括不可见(字母数字、标点符号等)ASCII集中的字符。除了预定义的数据集和缓冲区的长度将被用来发送数据外，模糊器还可以生成伪随机数据，该数据将扩大由程序员定义的测试集。

## 0x03 用于软件漏洞检测的Fuzzing方法

### 3.1 智能Fuzzing

智能模糊器分为六个部分：1）漏洞模式。在程序集级别定义漏洞模式。这些模式有助于识别二进制文件中有趣的函数。2）污染分析。考虑到在前一步中获得的信息，将对二进制文件进行污染分析。潜在的危险数据将被标记为受污染，并将跟踪它们在执行时的传播。3）测试生成。测试生成被应用在使用concolic执行和搜索算法中，以审计被测试应用程序的最危险路径，并为每一个新的执行生成更好的质量测试。4）覆盖率分析。在生成和执行测试之后，通过覆盖率分析技术来评估模糊化的有效性。5）财产检查。6）可利用模式。评估每个检测到的漏洞的潜在可利用性。

#### 3.1.1 漏洞模式

识别二进制文件中潜在易受攻击的代码序列，以便了解应该测试的二进制文件中最危险的部分。其思想是基于已经发现的漏洞和VUPEN安全专家在发现和利用二进制文件中的安全漏洞方面的经验来定义漏洞“模式”。漏洞模式表示程序集级别的模型，该模型可能导致错误，尤其是内存损坏。源代码中易受攻击的函数的示例是strcmp，其中函数参数可以由用户控制。这种常见情况允许以不安全的方式访问内存，从而产生缓冲区溢出。

#### 3.1.2 污染分析

污染分析通常包括将来自不可信源(如网络和用户输入)的数据标记为受污染的数据。它可以用于跟踪受污染数据的传播，并检查何时以危险的方式使用受污染数据，例如覆盖返回地址。

数据污染将通过使用有关漏洞的信息（例如路径执行）来选择能够触发潜在漏洞并限制测试空间的最有希望的测试序列，从而改善模糊测试。

存在许多污染分析工具。Dytan是一个动态的污染分析框架，适用于Windows和Linux，它不需要重新编译或访问源代码就可以检测二进制文件。MyNav是一个为IDA Pro反汇编创建的插件，用于帮助逆向工程师完成他们的任务。它有助于动态地分析程序。虽然它不是一个污染分析框架，但可以在这种情况下使用。它的功能包括查找感兴趣的函数和输入之间的路径。

#### 3.1.3 测试生成

生成模糊数据是模糊测试过程中最重要的一步。该步骤可以以不同方式进行。可以通过对现有数据应用突变或对目标(文件处理器/协议)建模来生成模糊数据。可以使用源代码、学习方法或目标规范创建模型。

为了触发可能揭示故障的特定路径，测试值的选择至关重要。我们的目标是生成最相关的测试用例。为此，可以使用concolic执行和搜索算法。 Concolic execution是一种基于使用具体值作为输入执行程序的系统路径探索技术;收集对这些输入的约束否定并解决约束以探索新的路径条件。一旦生成约束，就必须使用约束求解器来求解约束。 Concoic执行允许我们通过生成新输入来探索新的执行路径。

可以使用搜索算法，例如遗传算法。由于通过对初始种群应用操作（突变，交叉......）的测试群体的演变，每次执行后测试的质量将得到改善。

在装配级应用污染分析来收集关于潜在危险数据的信息；然后，程序将使用具体的值执行，以生成探索新路径的输入，并选择最有希望触发潜在漏洞的测试序列，同时考虑到前面步骤中收集的信息。在第一次执行之后，我们将搜索算法(如遗传算法)应用到之前生成的输入总体上，以改进测试生成过程，这得益于交叉和变异操作，当应用于测试总体时，为下一次执行生成更好的质量测试。

#### 3.1.4 覆盖率分析

使用这些新输入生成模糊化数据并执行目标之后，必须使用代码覆盖技术评估模糊化过程的有效性。Fuzzing评估是测量程序测试的好坏，并确定扩展覆盖范围所需的修改。其思想是实现一种跟踪二进制执行的技术。它包括使用PyDbg跟踪基本块的执行，以在每个基本块中设置断点，并检查是否命中了断点，以评估覆盖率。IDA2SQL通过将程序信息(基本块、函数……)导出到MySQL数据库来完成这项任务。

#### 3.1.5 财产检查

在模糊测试过程中，必须监视程序执行时可能出现的故障。如果在执行时附加到程序，则反汇编和调试功能便于进行此类监视。这个过程中不仅要监视异常，还要在运行时系统地识别违规行为，以避免隐藏的漏洞。以这种方式检测故障的发生改善了故障检测能力。由于装配程序的复杂性，在装配级工作使得这项任务更加困难。

#### 3.1.6 可利用性

如果在最后一步中发现故障，则必须在其上执行流程以确定其潜在的可利用性。当一个漏洞被触发时，分析从二进制文件（如堆栈或堆内容）收集的信息将是评估其潜在可利用性的一个有趣的方向。目前，有许多工具，如Miller的二进制分析工具BitBlaze，可以帮助确定崩溃是否是由可能被利用的漏洞引起的；但是这些工具不能提供可靠的信息。

## 0x04 XSS漏洞的模糊测试

### 4.1 XSS漏洞原理

- XSS（Cross-Site Scripting）即跨站点脚本，是一种JavaScript代码注入攻击，允许攻击者在受害者的Web浏览器中执行注入的JavaScript来访问敏感资源，如cookies，密码，信用卡号码等。XSS是在客户端浏览器上的一种攻击手段，但是其功能是在服务器端被利用。为了利用Web应用程序上的XSS漏洞，攻击者在Web应用程序上构造并注入恶意的JavaScript负载。这个脚本注入方式似乎是网站的良性组件，并且这个脚本最终在网站的信任域内执行。

- 由于有多种技术可以讲恶意的JavaScript代码注入受害者的Web应用程序中，但攻击者最常用的方式是将脚本注入其中一个网站页面，以便受害者从网站下载脚本。只有当Web应用程序接受来自用户端的输入到其网页时，才有可能这样做，因为攻击者可以注入恶意JavaScript字符串，该字符串将作为代码反映在受害者的浏览器上。

- 以下是一段包含XSS漏洞的PHP代码：

  ```php
  <?php
  $msg = $_GET['msg'];
  // 用户提交的消息被作为关键字提交到后台进行信息检索
  // 页面同时把用户输入的搜索关键词展示出来
  echo "<div>$msg</div>";
  ```

  假设用户提交的msg为`<img src=1 onerror=alert(1)>`，PHP输出给浏览器的内容就是：`<div><img src=1 onerror=alert(1)></div>`，这段HTML代码被浏览器解释执行的结果就是执行了其中包含的JavaScript代码。（执行结果会有一个显示1的弹框）。

- 在某些特定情况下，JavaScript代码被恶意攻击的可能性非常高：
  - JavaScript有效载荷可以访问用户的敏感凭据，如cookie，密码，信用卡号等；
  - JavaScript可以利用XML-HTTP请求和其它一些内置方法将HTTP请求传输到Web 服务器；
  - JavaScript可以利用文档对象模型（DOM）操作技术的功能改变Web页面的语法和语义。
- 在易受攻击的Web应用程序中注入恶意的JavaScript代码会有以下负面影响：
  - Cookie窃取。攻击者可以通过在易受攻击的Web应用程序中注入XSS攻击向量来窃取会话id或会话劫持来窃取Cookie。
  - 网络钓鱼攻击。攻击者可以利用DOM操纵的功能，通过注入伪造的登录表单，欺骗受害者提供他/她的敏感凭证来攻击web服务器。
  - 密钥记录。攻击者可以利用键盘事件监听器的功能来跟踪受害者的所有按键，并将这些信息传输到Web服务器，以访问密码、信用卡号码等敏感信息。

### 4.2 XSS漏洞类别

#### 4.2.1 持久型攻击

- 这种类型的XSS攻击也称为存储XSS攻击，会把用户输入的数据“存储”在服务器或客户端（例如：Cookie、LocalStorage、Web SQL等）。其中，“存储”在服务器上的 XSS 代码具有很强的利用稳定性，只要用户再次打开存在 XSS 漏洞的网站，攻击者预留在这个网站的 XSS 漏洞都可以被自动载入执行。

- 以下是一个持久型攻击的例子：

  ```php+HTML
  <form action="" method="post">
      <input type="text" name="xss"/>
      <input type="submit" value="test"/>
  </form>
  <?php
  $xss=@$_POST['xss'];
  mysql_connect("localhost","root","123");
  mysql_select_db("xss");
  if($xss!==null){
      $sql="insert into temp(id,payload) values('1','$xss')";
      $result=mysql_query($sql);
      echo $result;
  }
  ```

  该段代码显示：用户输入的内容没有经过过滤，不直接显示在页面中，直接插入到了数据库中。存储行 XSS 的数据流向是：浏览器 -> 后端 -> 数据库 -> 后端 -> 浏览器。

- 持久型攻击的一般过程是：攻击者利用其中一个Web应用程序表单将恶意JavaScript字符串注入到网站的存储库中。然后受害者浏览易受攻击的网站并从Web应用程序请求访问网页。Web应用程序在HTTP响应消息中包含Web应用程序存储库中的恶意JavaScript字符串，并将其传输到受害者的浏览器。受害者Web应用程序的Web浏览器在HTTP响应消息中运行恶意JavaScript代码，最后将受害者的敏感信息传输到攻击者的Web服务器。

#### 4.2.2 非持久型攻击

- 非持久型攻击只是简单地把用户输入的数据“反射”给浏览器。也就是说，攻击者往往需要诱骗用户“点击”一个恶意链接，链接中包含 XSS 代码，才能攻击成功。非持久型 XSS也被称为“反射型 XSS ”。

- 以下是一个非持久型攻击的例子：

  ```php+HTML
  <form action="" method="get">
      <input type="text" name="xss"/>
      <input type="submit" value="test"/>
  </form>
  <?php
  $xss = @$_GET['xss'];
  if($xss!==null){
      echo $xss;
  }
  ```

  如果输入为`<script>alert('hack')</script>`，就会有弹框。非持久型 XSS 的数据流向是：浏览器 -> 后端 -> 浏览器。

- 非持久型攻击的一般过程是：攻击者创建包含恶意JavaScript字符串的URL并将其传输到Web浏览器。然后攻击者欺骗受害者从VWA请求URL地址。VWA包含来自HTTP响应中URL地址的恶意注入JavaScript字符串。受害者的Web浏览器在HTTP响应消息中运行注入的JavaScript时，受害者的凭据（例如密码，cookie等）就会发送到攻击者的服务器。

### 4.3 XSS漏洞的模糊测试

- 模糊测试的主要流程：
  1. HTTP请求
  2. 插件初始化（包括解析插件配置，加载检测规则，解析用户输入等）
  3. 检测输入入口（包括POST XSS检测，GET XSS检测，COOKIE XSS检测等）
  4. 检测潜在的注入点
  5. 随即注入字符
  6. 修改注入向量值
  7. 提交请求
  8. 判断字符串存在与否
  9. 结束检测

- 检测输入点就是寻找例如GET或者是POST数据，或者是HTTP头中的Cookie信息等等。形象的例子就是在搜索框中提交要查找的关键词进行搜索，这里就发生了GET请求或者是POST请求，这里就是一个输入点。

- 潜在注入点的检测就是判断输入点能否注入数据到页面上。潜在注入点的检测通常使用一个随机字符串，再判断这个随机字符串是否返回输出在页面，以此来进行判断。

- 生成Payload。Payload决定了攻击能否成功，不同情况的注入点需要的Payload也是不同的。

  ```
  标签属性中：如<a href="注入位置">test</a>，Payload："></a><script>alert(0)</script><a  href="
  标签事件中：<img href="a.jpg" onload="注入位置">, Payload：alert(0)
  ```

## 0x05 总结

一个好的模糊工具应该能够测试一个完整的协议，包括前阶段和后阶段。模糊工具还可以检测已经在正在测试的应用程序中发布和修补的安全漏洞。这允许用户测试模糊器工具的效率。

模糊测试技术允许在短时间内检测各种应用程序的关键安全漏洞。重要的是，模糊测试虽然有效，但并不能检测应用程序中存在的所有安全漏洞的最终解决方案。由于某些安全漏洞的性质，使用模糊测试是不可能检测到的。
采用模糊化方法的主要优点是简单、高效和自动化，大大加快了安全漏洞检测的全过程。